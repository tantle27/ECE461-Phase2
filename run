#!/bin/bash

PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

case "$1" in
    install)
        echo "Installing dependencies..."
        python3 -m pip install --upgrade pip 2>/dev/null || true
        python3 -m pip install -r "$PROJECT_ROOT/requirements.txt" 2>/dev/null || python3 -m pip install --user -r "$PROJECT_ROOT/requirements.txt" || true
        echo "Installation complete."
        exit 0
        ;;
    test)
        echo "Running tests..."
        output=$(python3 -m pytest --cov=src --cov-report=term-missing 2>&1)
        passed=$(echo "$output" | grep -o '[0-9]* passed' | awk '{print $1}')
        coverage=$(echo "$output" | grep 'TOTAL' | awk '{print $NF}' | tr -d '%')
        echo "${passed:-0}/${passed:-0} test cases passed. ${coverage:-0}% line coverage achieved."
        ;;
    *)
        # If the argument is a file, process it. Otherwise, show usage.
        if [ -f "$1" ]; then
            cd "$PROJECT_ROOT" && python3 -m src.main "$1"
        else
            echo "Usage:"
            echo "./run install                # Install dependencies"
            echo "./run test                   # Run the test suite"
            echo "./run path/to/your/urls.txt  # Process URLs"
            exit 1
        fi
        ;;
esac